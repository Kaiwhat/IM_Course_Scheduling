<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>資管系課表 114-1</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page-container">
    <header class="page-header">
      <h1 id="schedule-title">國立暨南國際大學資管系課程資訊</h1>
      <div id="file-upload-block">
        <input type="file" id="csvFile" accept=".csv,.json" />
      </div>
      <div class="grade-filter">
        <button class="grade-btn active" data-grade="all">總覽</button>
        <button class="grade-btn" data-grade="1">大一</button>
        <button class="grade-btn" data-grade="2">大二</button>
        <button class="grade-btn" data-grade="3">大三</button>
        <button class="grade-btn" data-grade="4">大四</button>
        <button class="grade-btn" data-grade="master">碩班</button>
      </div>
      <div class="instruction-text">
        若想了解該課程詳細資訊,請點選「檢視」即可查看。含為推薦「學士班學生預修碩士班課程申請」者可以修習。
      </div>
    </header>
    <main class="schedule-main">
      <div class="table-outer-border">
        <div id="schedule"></div>
      </div>
    </main>
    <div id="legend">
      <span class="legend cell-must">校必修</span>
      <span class="legend cell-college">院必修</span>
      <span class="legend cell-dept">系必修</span>
      <span class="legend cell-tech">技術次領域</span>
      <span class="legend cell-mgmt">管理次領域</span>
      <span class="legend cell-elective">專業選修</span>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const periodTimes = {
      'A': ['8:10', '9:00'], 'B': ['9:10', '10:00'], 'C': ['10:10', '11:00'], 'D': ['11:10', '12:00'],
      'Z': ['12:10', '13:00'], 'E': ['13:10', '14:00'], 'F': ['14:10', '15:00'], 'G': ['15:10', '16:00'],
      'H': ['16:10', '17:00'], 'I': ['17:10', '18:00'], 'J': ['18:10', '19:00']
    };

    const typeColorMap = {
      '基礎院本課程必修': 'cell-college',
      '專業必修': 'cell-dept',
      '專業選修': 'cell-elective',
      '校必修': 'cell-must',
      '院必修': 'cell-college',
      '系必修': 'cell-dept',
      '技術次領域': 'cell-tech',
      '管理次領域': 'cell-mgmt',
    };

    const weekDays = ['一', '二', '三', '四', '五'];
    const periods = ['A', 'B', 'C', 'D', 'Z', 'E', 'F', 'G', 'H', 'I', 'J'];

    function parseCourseTimes(timeStr) {
      if (!timeStr) return [];
      return timeStr.split(',').map(t => {
        const m = t.match(/(\d)([a-zA-Z]+)/);
        if (!m) return null;
        return { dayIdx: parseInt(m[1], 10) - 1, periods: m[2].toUpperCase().split('') };
      }).filter(Boolean);
    }

    // 修復表格邊框的函數
    function fixTableBorders(table) {
      const trs = table.querySelectorAll('tr');
      
      // 1. 確保所有最後一行的單元格都有下邊框
      const lastRow = trs[trs.length - 1];
      if (lastRow) {
        const cells = lastRow.querySelectorAll('td, th');
        cells.forEach(cell => {
          cell.style.borderBottom = '2px solid #bcbcbc';
        });
      }
      
      // 2. 確保所有最右列的單元格都有右邊框
      trs.forEach((tr, rowIndex) => {
        const cells = tr.querySelectorAll('td, th');
        if (cells.length > 0) {
          const lastCell = cells[cells.length - 1];
          lastCell.style.borderRight = '2px solid #bcbcbc';
        }
      });
      
      // 3. 特別處理有 rowspan 的單元格
      const allCells = table.querySelectorAll('td[rowspan], th[rowspan]');
      allCells.forEach(cell => {
        const rowspan = parseInt(cell.getAttribute('rowspan') || '1', 10);
        
        // 如果這個單元格延伸到表格底部，確保有下邊框
        const parentRow = cell.closest('tr');
        const rowIndex = Array.from(trs).indexOf(parentRow);
        
        if (rowIndex + rowspan >= trs.length) {
          cell.style.borderBottom = '2px solid #bcbcbc';
        }
        
        // 如果這個單元格在最右列，確保有右邊框
        const cellIndex = Array.from(parentRow.children).indexOf(cell);
        if (cellIndex === parentRow.children.length - 1) {
          cell.style.borderRight = '2px solid #bcbcbc';
        }
      });
      
      // 4. 確保表格本身的邊框完整
      table.style.border = '2px solid #bcbcbc';
      
      // 5. 特別處理右下角
      let rightBottomCell = null;
      for (let i = trs.length - 1; i >= 0; i--) {
        const row = trs[i];
        const cells = row.querySelectorAll('td, th');
        if (cells.length > 0) {
          for (let j = cells.length - 1; j >= 0; j--) {
            const cell = cells[j];
            if (!cell.classList.contains('period-header')) {
              rightBottomCell = cell;
              break;
            }
          }
          if (rightBottomCell) break;
        }
      }
      
      if (rightBottomCell) {
        rightBottomCell.style.borderRight = '2px solid #bcbcbc';
        rightBottomCell.style.borderBottom = '2px solid #bcbcbc';
      }
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
      if (!e.target.files.length) return;
      document.getElementById('file-upload-block').style.display = 'none';
      
      const file = e.target.files[0];
      if (file.name.endsWith('.json')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const jsonData = JSON.parse(e.target.result);
          allCourses = jsonData.courses;
          setupGradeFilter();
          filterCourses('all');
        };
        reader.readAsText(file);
      } else {
        Papa.parse(file, {
          header: true,
          encoding: "UTF-8",
          complete: function(results) {
            allCourses = results.data;
            setupGradeFilter();
            filterCourses('all');
          }
        });
      }
    });

    let allCourses = [];
    let currentFilter = 'all';

    function setupGradeFilter() {
      const gradeButtons = document.querySelectorAll('.grade-btn');
      gradeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          gradeButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          const grade = this.getAttribute('data-grade');
          currentFilter = grade;
          filterCourses(grade);
        });
      });
    }

    function filterCourses(grade) {
      if (grade === 'all') {
        renderSchedule(allCourses);
        return;
      }

      let filteredCourses = [];
      
      if (grade === 'master') {
        filteredCourses = allCourses.filter(course => {
          const gradeInfo = course['開課年級'] || '';
          const courseType = course['學制'] || '';
          return courseType.includes('碩士班') || gradeInfo.includes('碩');
        });
      } else {
        filteredCourses = allCourses.filter(course => {
          const gradeInfo = course['開課年級'] || '';
          return gradeInfo.toString() === grade;
        });
      }

      renderSchedule(filteredCourses);
    }

    function updateScheduleTitle() {
      const titleElement = document.getElementById('schedule-title');
      let title = '國立暨南國際大學資管系課程資訊';
      
      if (currentFilter !== 'all') {
        const gradeNames = {
          '1': '大一',
          '2': '大二', 
          '3': '大三',
          '4': '大四',
          'master': '碩班'
        };
        title = `國立暨南國際大學資管系${gradeNames[currentFilter]}課程資訊`;
      }
      
      titleElement.textContent = title;
    }

    function renderSchedule(data) {
      updateScheduleTitle();
      
      const table = document.createElement('table');
      table.className = 'schedule-table';
      let thead = '<tr><th></th>' + weekDays.map(d => `<th>星期${d}</th>`).join('') + '</tr>';
      table.innerHTML = thead;
      const tableBody = document.createElement('tbody');
      for (let p of periods) {
        let timeBlock = '';
        if (periodTimes[p]) {
          timeBlock = `<span class="period-time">${periodTimes[p][0]}<br>-<br>${periodTimes[p][1]}</span>`;
        }
        if (p === 'Z') {
          let row = `<tr><th class="period-header">${p}<br>${timeBlock}</th><td class="lunch-break" colspan="${weekDays.length}">午間休息</td></tr>`;
          tableBody.innerHTML += row;
          continue;
        }
        let row = `<tr><th class="period-header">${p}<br>${timeBlock}</th>`;
        for (let d = 0; d < weekDays.length; d++) {
          row += `<td id="cell-${p}-${d}"></td>`;
        }
        row += '</tr>';
        tableBody.innerHTML += row;
      }
      table.appendChild(tableBody);

      const groupedCourses = {};
      data.forEach(course => {
        if (!course['課程名稱']) return;
        const times = parseCourseTimes(course['上課時間']);
        
        times.forEach(({ dayIdx, periods }) => {
          if (periods.length === 0) return;
          const startPeriod = periods[0];
          const key = `${dayIdx}-${startPeriod}`;
          if (!groupedCourses[key]) {
            groupedCourses[key] = [];
          }
          groupedCourses[key].push({ ...course, periods });
        });
      });

      const cellsToRemove = new Set();
      for (const key in groupedCourses) {
        const originalCourses = groupedCourses[key];
        if (originalCourses.length === 0) continue;

        let rowspan = 0;
        let longestCoursePeriods = [];
        for (const c of originalCourses) {
          if (c.periods && c.periods.length > rowspan) {
            rowspan = c.periods.length;
            longestCoursePeriods = c.periods;
          }
        }
        
        const specialCourseName = '資訊管理專題與個案';
        const specialCourses = originalCourses.filter(c => c['課程名稱']?.startsWith(specialCourseName));
        const otherCourses = originalCourses.filter(c => !c['課程名稱']?.startsWith(specialCourseName));
        
        let finalCourses = otherCourses;

        if (specialCourses.length > 0) {
          const firstSpecial = specialCourses[0];
          const combinedTeachers = specialCourses
            .map(c => `${c['班級']}-${c['任課教師']}/${c['上課教室']}`)
            .join('<br>');
          
          const combinedCourse = {
            ...firstSpecial,
            '任課教師': combinedTeachers,
            isCombined: true,
          };
          finalCourses.push(combinedCourse);
        }

        const dayIdx = parseInt(key.split('-')[0], 10);
        const startPeriod = key.split('-')[1];
        
        const startCell = table.querySelector(`#cell-${startPeriod}-${dayIdx}`);
        if (!startCell) continue;

        startCell.rowSpan = rowspan;
        startCell.classList.add('has-course');

        let innerContent = '';
        finalCourses.forEach(course => {
            let blockContent = '';
            const courseName = course['課程名稱'] ? course['課程名稱'].replace(/([^(（]+)([\(（][^)）]+[\)）])/, '<span class="course-title">$1$2</span>') : '';
            const gradeInfo = course['開課年級'] || '';
            
            if (course.isCombined) {
                blockContent = `${courseName}<br>(${gradeInfo})<br>${course['任課教師']}`;
            } else {
                let courseUrl = '';
                if (course['SemesterCourseName'] && course['SemesterCourseName'].includes('href=')) {
                    const match = course['SemesterCourseName'].match(/href="([^"]+)"/);
                    if (match) {
                        courseUrl = match[1];
                    }
                }
                blockContent = `${courseName}<br>(${gradeInfo})<br>${course['任課教師']}<br>${course['上課教室']}<br><a href="${courseUrl}" target="_blank" class="view-link">檢視</a>`;
            }
            innerContent += `<div class="course-block ${typeColorMap[course['修別']] || 'cell-elective'}">
                            ${blockContent}
                        </div>`;
        });
        startCell.innerHTML = `<div class="cell-content-wrapper">${innerContent}</div>`;
        
        for (let i = 1; i < rowspan; i++) {
            const periodToRemove = longestCoursePeriods[i];
            if (periodToRemove) {
                cellsToRemove.add(`cell-${periodToRemove}-${dayIdx}`);
            }
        }
      }

      cellsToRemove.forEach(cellId => {
        const cell = table.querySelector(`#${cellId}`);
        if (cell) cell.remove();
      });

      const scheduleDiv = document.getElementById('schedule');
      scheduleDiv.innerHTML = '';
      scheduleDiv.appendChild(table);

      // 使用新的邊框修復函數
      fixTableBorders(table);
    }
  </script>
</body>
</html>