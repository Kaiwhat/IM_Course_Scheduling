<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>資管系課表 114-1</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page-container">
    <header class="page-header">
      <h1 id="schedule-title">國立暨南國際大學資管系課程資訊</h1>
      <div id="file-upload-block">
        <input type="file" id="csvFile" accept=".csv,.json" />
      </div>
      <div class="grade-filter">
        <button class="grade-btn active" data-grade="all">總覽</button>
        <button class="grade-btn" data-grade="1">大一</button>
        <button class="grade-btn" data-grade="2">大二</button>
        <button class="grade-btn" data-grade="3">大三</button>
        <button class="grade-btn" data-grade="4">大四</button>
        <button class="grade-btn" data-grade="master">碩班</button>
      </div>
      <div class="instruction-text">
        若想了解該課程詳細資訊,請點選「檢視」即可查看。含為推薦「學士班學生預修碩士班課程申請」者可以修習。
      </div>
    </header>
    <main class="schedule-main">
      <div class="table-outer-border">
        <div id="schedule"></div>
      </div>
    </main>
    <div id="legend">
      <span class="legend cell-must">校必修</span>
      <span class="legend cell-college">院必修</span>
      <span class="legend cell-dept">系必修</span>
      <span class="legend cell-tech">技術次領域</span>
      <span class="legend cell-mgmt">管理次領域</span>
      <span class="legend cell-elective">專業選修</span>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const periodTimes = {
      'A': ['8:10', '9:00'], 'B': ['9:10', '10:00'], 'C': ['10:10', '11:00'], 'D': ['11:10', '12:00'],
      'Z': ['12:10', '13:00'], 'E': ['13:10', '14:00'], 'F': ['14:10', '15:00'], 'G': ['15:10', '16:00'],
      'H': ['16:10', '17:00'], 'I': ['17:10', '18:00'], 'J': ['18:10', '19:00']
    };

    const typeColorMap = {
      '基礎院本課程必修': 'cell-college',
      '專業必修': 'cell-dept',
      '專業選修': 'cell-elective',
      '校必修': 'cell-must',
      '院必修': 'cell-college',
      '系必修': 'cell-dept',
      '技術次領域': 'cell-tech',
      '管理次領域': 'cell-mgmt',
    };



    const weekDays = ['一', '二', '三', '四', '五'];
    const periods = ['A', 'B', 'C', 'D', 'Z', 'E', 'F', 'G', 'H', 'I', 'J'];

    function parseCourseTimes(timeStr) {
      if (!timeStr) return [];
      return timeStr.split(',').map(t => {
        const m = t.match(/(\d)([a-zA-Z]+)/);
        if (!m) return null;
        return { dayIdx: parseInt(m[1], 10) - 1, periods: m[2].toUpperCase().split('') };
      }).filter(Boolean);
    }

    // 測試時間解析
    function testTimeParsing() {
      const testTime = '4hij';
      const result = parseCourseTimes(testTime);
      console.log('測試時間解析:', testTime, '結果:', result);
    }

    document.getElementById('csvFile').addEventListener('change', function(e) {
      if (!e.target.files.length) return;
      document.getElementById('file-upload-block').style.display = 'none';
      
      const file = e.target.files[0];
      if (file.name.endsWith('.json')) {
        // 讀取 JSON 檔案
        const reader = new FileReader();
        reader.onload = function(e) {
          const jsonData = JSON.parse(e.target.result);
          allCourses = jsonData.courses; // 儲存所有課程資料
          setupGradeFilter(); // 設定年級篩選功能
          filterCourses('all'); // 預設顯示所有課程
        };
        reader.readAsText(file);
      } else {
        // 讀取 CSV 檔案
        Papa.parse(file, {
          header: true,
          encoding: "UTF-8",
          complete: function(results) {
            allCourses = results.data; // 儲存所有課程資料
            setupGradeFilter(); // 設定年級篩選功能
            filterCourses('all'); // 預設顯示所有課程
          }
        });
      }
    });

    let allCourses = []; // 儲存所有課程資料
    let currentFilter = 'all'; // 目前選中的篩選條件

    // 年級篩選功能
    function setupGradeFilter() {
      const gradeButtons = document.querySelectorAll('.grade-btn');
      gradeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          // 移除所有按鈕的 active 狀態
          gradeButtons.forEach(b => b.classList.remove('active'));
          // 為當前按鈕添加 active 狀態
          this.classList.add('active');
          
          const grade = this.getAttribute('data-grade');
          currentFilter = grade;
          filterCourses(grade);
        });
      });
    }

    // 篩選課程
    function filterCourses(grade) {
      if (grade === 'all') {
        renderSchedule(allCourses);
        return;
      }

      let filteredCourses = [];
      
      if (grade === 'master') {
        // 碩班課程：開課年級包含碩士班相關資訊
        filteredCourses = allCourses.filter(course => {
          const gradeInfo = course['開課年級'] || '';
          const courseType = course['學制'] || '';
          const isMaster = courseType.includes('碩士班') || gradeInfo.includes('碩');
          
          // 特別檢查 Linux 課程
          if (course['課程名稱'] && course['課程名稱'].includes('Linux')) {
            console.log('Linux 課程篩選檢查:', {
              courseName: course['課程名稱'],
              gradeInfo: gradeInfo,
              courseType: courseType,
              isMaster: isMaster
            });
          }
          
          return isMaster;
        });
      } else {
        // 大學部課程：根據開課年級篩選
        filteredCourses = allCourses.filter(course => {
          const gradeInfo = course['開課年級'] || '';
          return gradeInfo.toString() === grade;
        });
      }

      renderSchedule(filteredCourses);
    }

    // 更新標題
    function updateScheduleTitle() {
      const titleElement = document.getElementById('schedule-title');
      let title = '國立暨南國際大學資管系課程資訊';
      
      if (currentFilter !== 'all') {
        const gradeNames = {
          '1': '大一',
          '2': '大二', 
          '3': '大三',
          '4': '大四',
          'master': '碩班'
        };
        title = `國立暨南國際大學資管系${gradeNames[currentFilter]}課程資訊`;
      }
      
      titleElement.textContent = title;
    }

    function renderSchedule(data) {
      // 更新標題
      updateScheduleTitle();
      
      // 測試時間解析
      testTimeParsing();
      
      console.log('渲染課程資料:', data.length, '筆');
      console.log('課程範例:', data.slice(0, 3));
      
      const table = document.createElement('table');
      table.className = 'schedule-table';
      let thead = '<tr><th></th>' + weekDays.map(d => `<th>星期${d}</th>`).join('') + '</tr>';
      table.innerHTML = thead;
      const tableBody = document.createElement('tbody');
      for (let p of periods) {
        let timeBlock = '';
        if (periodTimes[p]) {
          timeBlock = `<span class="period-time">${periodTimes[p][0]}<br>-<br>${periodTimes[p][1]}</span>`;
        }
        if (p === 'Z') {
          // Z 列顯示午間休息，合併所有欄位
          let row = `<tr><th class="period-header">${p}<br>${timeBlock}</th><td class="lunch-break" colspan="${weekDays.length}">午間休息</td></tr>`;
          tableBody.innerHTML += row;
          continue;
        }
        let row = `<tr><th class="period-header">${p}<br>${timeBlock}</th>`;
        for (let d = 0; d < weekDays.length; d++) {
          row += `<td id="cell-${p}-${d}"></td>`;
        }
        row += '</tr>';
        tableBody.innerHTML += row;
      }
      table.appendChild(tableBody);

      const groupedCourses = {};
      data.forEach(course => {
        if (!course['課程名稱']) {
          console.log('跳過無課程名稱的資料:', course);
          return;
        }
        const times = parseCourseTimes(course['上課時間']);
        console.log('課程:', course['課程名稱'], '時間:', course['上課時間'], '解析結果:', times);
        
        // 特別檢查 Linux 課程
        if (course['課程名稱'] && course['課程名稱'].includes('Linux')) {
          console.log('=== Linux 課程詳細資訊 ===');
          console.log('課程名稱:', course['課程名稱']);
          console.log('上課時間:', course['上課時間']);
          console.log('解析結果:', times);
          console.log('開課年級:', course['開課年級']);
          console.log('任課教師:', course['任課教師']);
          console.log('上課教室:', course['上課教室']);
          console.log('=======================');
        }
        times.forEach(({ dayIdx, periods }) => {
          if (periods.length === 0) return;
          const startPeriod = periods[0];
          const key = `${dayIdx}-${startPeriod}`;
          console.log('課程:', course['課程名稱'], '分配到格子:', key, 'dayIdx:', dayIdx, 'periods:', periods);
          if (!groupedCourses[key]) {
            groupedCourses[key] = [];
          }
          groupedCourses[key].push({ ...course, periods });
        });
      });

      console.log('分組後的課程:', groupedCourses);

      const cellsToRemove = new Set();
      for (const key in groupedCourses) {
        const originalCourses = groupedCourses[key];
        if (originalCourses.length === 0) continue;

        console.log('處理課程組:', key, originalCourses.map(c => c['課程名稱']));

        let rowspan = 0;
        let longestCoursePeriods = [];
        for (const c of originalCourses) {
          if (c.periods && c.periods.length > rowspan) {
            rowspan = c.periods.length;
            longestCoursePeriods = c.periods;
          }
        }
        
        const specialCourseName = '資訊管理專題與個案';
        const specialCourses = originalCourses.filter(c => c['課程名稱']?.startsWith(specialCourseName));
        const otherCourses = originalCourses.filter(c => !c['課程名稱']?.startsWith(specialCourseName));
        
        let finalCourses = otherCourses;

        if (specialCourses.length > 0) {
          const firstSpecial = specialCourses[0];
          const combinedTeachers = specialCourses
            .map(c => `${c['班級']}-${c['任課教師']}/${c['上課教室']}`)
            .join('<br>');
          
          const combinedCourse = {
            ...firstSpecial,
            '任課教師': combinedTeachers,
            isCombined: true,
          };
          finalCourses.push(combinedCourse);
        }

        const dayIdx = parseInt(key.split('-')[0], 10);
        const startPeriod = key.split('-')[1];
        
        const startCell = table.querySelector(`#cell-${startPeriod}-${dayIdx}`);
        if (!startCell) {
          console.log('找不到格子:', `#cell-${startPeriod}-${dayIdx}`);
          continue;
        }

        console.log('渲染課程到格子:', `#cell-${startPeriod}-${dayIdx}`, finalCourses.map(c => c['課程名稱']));

        startCell.rowSpan = rowspan;
        startCell.classList.add('has-course');

        // 決定這個格子是否要加下邊框（如果它的rowspan延伸到最後一列）
        const periodIndex = periods.indexOf(startPeriod);
        let isBottomBorder = false;
        if (periodIndex > -1 && (periodIndex + rowspan === periods.length)) {
          startCell.classList.add('cell-bottom-border');
        }

        let innerContent = '';
        finalCourses.forEach(course => {
            let blockContent = '';
            // 課名與括號合併不換行
            const courseName = course['課程名稱'] ? course['課程名稱'].replace(/([^(（]+)([\(（][^)）]+[\)）])/, '<span class="course-title">$1$2</span>') : '';
            
            // 取得開課年級資訊
            const gradeInfo = course['開課年級'] || '';
            
            if (course.isCombined) {
                // 專題課程不顯示學分數
                blockContent = `${courseName}<br>(${gradeInfo})<br>${course['任課教師']}`;
            } else {
                // 從 SemesterCourseName 中提取連結
                let courseUrl = '';
                if (course['SemesterCourseName'] && course['SemesterCourseName'].includes('href=')) {
                    const match = course['SemesterCourseName'].match(/href="([^"]+)"/);
                    if (match) {
                        courseUrl = match[1];
                    }
                }
                blockContent = `${courseName}<br>(${gradeInfo})<br>${course['任課教師']}<br>${course['上課教室']}<br><a href="${courseUrl}" target="_blank" class="view-link">檢視</a>`;
            }
            innerContent += `<div class="course-block ${typeColorMap[course['修別']] || 'cell-elective'}">
                            ${blockContent}
                        </div>`;
        });
        startCell.innerHTML = `<div class="cell-content-wrapper">${innerContent}</div>`;
        
        for (let i = 1; i < rowspan; i++) {
            const periodToRemove = longestCoursePeriods[i];
            if (periodToRemove) {
                cellsToRemove.add(`cell-${periodToRemove}-${dayIdx}`);
            }
        }
      }

      cellsToRemove.forEach(cellId => {
        const cell = table.querySelector(`#${cellId}`);
        if (cell) cell.remove();
      });

      const scheduleDiv = document.getElementById('schedule');
      scheduleDiv.innerHTML = '';
      scheduleDiv.appendChild(table);

      // 補強右下角外框：動態補齊每一欄最後一個 td 的下邊框
      const trs = table.querySelectorAll('tr');
      const lastRowIndex = trs.length - 1;
      const colCount = weekDays.length + 1; // +1 for period header
      for (let col = 1; col < colCount; col++) { // 從1開始，0是節次
        let lastCell = null;
        let rowSum = 0;
        for (let row = 0; row < trs.length; row++) {
          const tds = trs[row].querySelectorAll('td, th');
          let cell = tds[col];
          if (!cell) continue;
          const rowspan = parseInt(cell.getAttribute('rowspan') || '1', 10);
          if (row + rowspan > trs.length - 1) {
            lastCell = cell;
            break;
          }
        }
        if (lastCell) {
          lastCell.style.borderBottom = '2px solid #bcbcbc';
        }
      }
    }
  </script>
</body>
</html> 